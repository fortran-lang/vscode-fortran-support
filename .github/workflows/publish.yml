name: Deploy Release

on:
  release:
    types: [published]

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      VERSION: ${{ steps.version.outputs.VERSION }}
      PRE_RELEASE: ${{ steps.pre.outputs.PRE_RELEASE }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v6
        with:
          node-version: 22.x

      - name: Capture prerelease flag
        id: pre
        run: echo "PRE_RELEASE=${{ github.event.release.prerelease }}" >> $GITHUB_OUTPUT

      - name: Derive version from tag
        id: version
        run: |
          ref="${GITHUB_REF_NAME}"
          version="${ref#v}"
          echo "VERSION=$version" >> $GITHUB_OUTPUT

  deploy-vscode:
    name: Publish Release (VS Code Marketplace)
    needs: prepare
    runs-on: ubuntu-latest
    environment: publish-vscode
    concurrency: publish-vscode
    env:
      VERSION: ${{ needs.prepare.outputs.VERSION }}
      PRE_RELEASE: ${{ needs.prepare.outputs.PRE_RELEASE }}
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: 22.x
      - run: npm ci

      - name: Package and publish to VS Code Marketplace
        run: |
          npm i -g @vscode/vsce
          if [ "${PRE_RELEASE}" = "true" ]; then
            vsce publish --no-git-tag-version --pre-release "${VERSION}"
          else
            vsce publish --no-git-tag-version "${VERSION}"
          fi
        env:
          VSCE_PAT: ${{ secrets.VS_MARKETPLACE_TOKEN }}

      - name: Upload VSIX to release assets
        uses: softprops/action-gh-release@master
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          files: ./*.vsix

  deploy-openvsx:
    name: Publish Release (OpenVSX)
    needs: prepare
    runs-on: ubuntu-latest
    environment: publish-openvsx
    concurrency: publish-openvsx
    env:
      VERSION: ${{ needs.prepare.outputs.VERSION }}
      PRE_RELEASE: ${{ needs.prepare.outputs.PRE_RELEASE }}
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version: 22.x
      - run: npm ci

      - name: Apply OpenVSX patch
        run: node ./scripts/patch-openvsx.mjs

      - name: Publish to OpenVSX
        run: |
          npm i -g @vscode/vsce ovsx
          if [ "${PRE_RELEASE}" = "true" ]; then
            vsce package --no-git-tag-version --pre-release "${VERSION}"
          else
            vsce package --no-git-tag-version "${VERSION}"
          fi
          ovsx publish ./*.vsix --skip-duplicate
        env:
          OVSX_PAT: ${{ secrets.OPENVSX_MARKETPLACE_TOKEN }}
